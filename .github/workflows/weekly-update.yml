name: "Weekly Updates"
on:
  workflow_call:
    secrets:
      REPO_TOKEN:
        description: "GitHub token with repo permissions"
        required: true
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-24.04
    steps:
      - name: Clone repository
        uses: actions/checkout@v5
        with:
          token: "${{ secrets.REPO_TOKEN }}"
      
      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          install_url: https://releases.nixos.org/nix/nix-2.24.9/install
          extra_nix_config: |
            experimental-features = nix-command flakes pipe-operators
      
      - name: Set up Git
        run: |
          git config user.email gitbot@mox-desktop.dev
          git config user.name "Git Bot"
      
      - name: Update dependencies
        run: |
          nix flake update
      
      - name: Commit and push changes
        run: |
          if git diff --quiet; then
            echo "No changes detected"
            exit 0
          fi
          git add .
          git commit -m "Weekly update: $(date '+%Y-%m-%d')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
